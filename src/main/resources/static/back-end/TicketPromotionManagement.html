<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>TirpLight後台</title>

    <!-- 自訂字型 -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="botcss/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link
          href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
          rel="stylesheet">
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="js/login.js"></script>
    <!-- 自訂樣式 -->
    <link href="css/TripLight.min.css" rel="stylesheet">
    <!-- 使用Bootstrap-table -->
    <link href="css/bootstrap-table.min.css" rel="stylesheet">



    <style>
        #employee-access {
            white-space: pre-line;
        }

        /* 文字灰色 */
        .my-text-lightgray {
            color: gray;
            font-weight: bold;
        }

        /* 避免表格被過度壓縮 */
        .my-th-width {
            min-width: 12rem;
        }

        /* 避免表格被過度壓縮 小按鈕*/
        .my-th-width-sm {
            min-width: 6rem;
        }
    </style>
</head>

<body id="page-top" style="overflow-y: scroll;">
    <!-- 頁面包裹區域 -->
    <div id="wrapper">

        <!-- 側邊欄 -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- 側邊欄 - 品牌 -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <img src="img/icon.png" alt="Icon" class="sidebar-brand-icon rotate-n-15"
                     style="width: 30px; height: 30px;">
                <div class="sidebar-brand-text mx-3">後台</div>
            </a>

            <!-- <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div> -->

            <!-- 導覽項目 -  -->
            <li class="nav-item active"><a class="nav-link"
                   href="/front-end/index.html"><span>TirpLight</span></a></li>

            <!-- 導覽項目 - 頁面折疊選單 -->
            <li class="nav-item" id="employee-management"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapseTwo" aria-expanded="true"
                   aria-controls="collapseTwo"> <span>員工管理</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="EmployeeQuety.html">查詢資料</a> <a
                           class="collapse-item" href="EmployeeRevise.html">新增資料</a>
                    </div>
                </div>
            </li>

            <!-- 導覽項目 - 公用程式折疊選單 -->
            <li class="nav-item" id="member-management"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapseUtilities" aria-expanded="true"
                   aria-controls="collapseUtilities"> <span>會員管理</span>
                </a>
                <div id="collapseUtilities" class="collapse"
                     aria-labelledby="headingUtilities" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="MemberQuety.html">查詢資料</a>
                    </div>
                </div>
            </li>

            <!-- 功能頁面 -->
            <li class="nav-item" id="firm-management"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapsePages" aria-expanded="true"
                   aria-controls="collapsePages"> <span>廠商管理</span>
                </a>
                <div id="collapsePages" class="collapse"
                     aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="FirmInert.html">廠商資料</a> <a
                           class="collapse-item" href="FirmRevise.html">行程管理</a>
                        <!--<a class="collapse-item" href="FirmReport.html">檢舉廠商</a> -->
                    </div>
                </div>
            </li>

            <li class="nav-item" id="ticket-management"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapseTickets" aria-expanded="true"
                   aria-controls="collapseTickets"> <span>票卷管理</span>
                </a>
                <div id="collapseTickets" class="collapse"
                     aria-labelledby="headingTickets" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="TicketManagement.html">票卷資料管理</a> <a
                           class="collapse-item" href="TicketOrderManagement.html">票卷訂單管理</a>
                        <a class="collapse-item" href="TicketPromotionManagement.html">票卷促銷管理</a>
                        <!--<a class="collapse-item" href="TicketSalesAnalysis.html">銷售分析</a> -->
                    </div>
                </div>
            </li>

            <li class="nav-item" id="web-management"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapseWebManagement" aria-expanded="true"
                   aria-controls="collapseWebManagement"> <span>網頁管理</span>
                </a>
                <div id="collapseWebManagement" class="collapse"
                     aria-labelledby="headingWebManagement"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="TravelArticles.html">文章管理</a>
                        <!-- <a class="collapse-item" href="ReportAriocles.html">檢舉管理</a> -->
                    </div>
                </div>
            </li>

            <li class="nav-item" id="customer-service"><a
                   class="nav-link collapsed" href="#" data-toggle="collapse"
                   data-target="#collapseCustomerService" aria-expanded="true"
                   aria-controls="collapseCustomerService"> <span>客服中心</span>
                </a>
                <div id="collapseCustomerService" class="collapse"
                     aria-labelledby="headingCustomerService"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="QuestionFormManagement.html">問題表單管理</a>
                        <a class="collapse-item" href="CustomerServiceChatManagement.html">客服聊天管理</a>
                    </div>
                </div>
            </li>
            <!-- 側邊欄切換器（側邊欄） -->
            <!-- <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div> -->
        </ul>
        <!-- 側邊導覽列結束 -->



        <!-- 內容包裹區域 -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- 主要內容 -->
            <div id="content">

                <!-- 上導覽列 -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- 側邊欄開關按鈕 -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>


                    <!-- 上導覽列導覽選單 -->
                    <ul class="navbar-nav ml-auto">

                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span
                                      class="mr-2 d-none d-lg-inline text-gray-600 small"
                                      id="employee-access"></span> <i class="fas fa-user-circle fa-lg"></i>
                            </a>
                            <!-- 下拉選單 - 使用者資訊 -->
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                 aria-labelledby="userDropdown" id="logoutLink">
                                <a class="dropdown-item" href="">
                                    登出
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>

                <!-- TODO: -->
                <div class="container">
                    <div class="row">

                        <div class="table-responsive p-3" id="promotionContainer">
                            <table class="table"
                                   data-toggle="table"
                                   data-sortable="true"
                                   data-sort-class="table-active"
                                   data-search="true"
                                   data-search-align="left">

                                <thead>
                                    <tr>
                                        <th class="my-th-width-sm" data-field="index" data-sortable="true">#</th>
                                        <th class="my-th-width" data-field="promotionTitle" data-sortable="true">促銷名稱</th>
                                        <th class="my-th-width" data-field="startDate" data-sortable="true">開始日期</th>
                                        <th class="my-th-width" data-field="endDate" data-sortable="true">結束日期</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 內容給JS填 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-primary m-3" id="addPromotionBtn">
                                新增促銷
                            </button>
                        </div>


                    </div>

                </div>



                <div class="container-fluid">

                    <div class="container d-none" id="detailContainer">
                        <div class="row p-3">
                            <div class="h3 my-5">
                                促銷明細<span class="text-muted mx-2">#<span id="promotionId">0000</span></span>
                            </div>

                            <div class="my-border-radius">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="my-th-width-sm">#</th>
                                                <th class="my-th-width-sm">票券名稱</th>
                                                <th class="my-th-width-sm">原價</th>
                                                <th class="my-th-width-sm">促銷價</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 內容給JS填 -->
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>



                    <!-- 稱高度用的 -->
                    <div style="height:30vh"></div>
                </div>



                <!-- 新增促銷的燈箱 -->
                <div class="modal fade" id="addPromotionModal" data-bs-backdrop="static" aria-hidden="true">
                    <div class="modal-dialog  modal-lg  modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">新增促銷</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        <button id="testBtn">一鍵新增資料(測試用)</button>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="addPromotionStartDate" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionStartDate">開始日期</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="addPromotionExpiryDate" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionExpiryDate">到期日期</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating m-3">
                                            <input type="text" class="form-control" id="addPromotionName" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionName">名稱</label>
                                        </div>
                                        <div class="m-3">
                                            <select class="form-select" id="ticketSelect">
                                                <option value="1">qq</option>
                                            </select>
                                        </div>
                                    </div>



                                    <div class="col-12" id="selectContainer">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th class="my-th-width-sm">票券編號</th>
                                                        <th class="my-th-width">票券名稱</th>
                                                        <th class="my-th-width-sm">原價</th>
                                                        <th class="my-th-width-sm">促銷價</th>
                                                        <th class="my-th-width-sm"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 內容給JS填 -->
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                                <div class="m-3 d-flex justify-content-end">
                                    <button class="btn btn-primary" id="addPromotionSubmit">確定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 編輯促銷的燈箱 -->
                <div class="modal fade" id="editPromotionModal" data-bs-backdrop="static" aria-hidden="true">
                    <div class="modal-dialog  modal-lg  modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">編輯促銷<span id="editPromotionId"></span></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="editPromotionStartDate" placeholder=".">
                                            <label class="my-text-lightgray" for="editPromotionStartDate">開始日期</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="editPromotionExpiryDate" placeholder=".">
                                            <label class="my-text-lightgray" for="editPromotionExpiryDate">到期日期</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating m-3">
                                            <input type="text" class="form-control" id="editPromotionName" placeholder=".">
                                            <label class="my-text-lightgray" for="editPromotionName">名稱</label>
                                        </div>
                                        <div class="m-3">
                                            <select class="form-select" id="editTicketSelect">
                                                <option value="1">qq</option>
                                            </select>
                                        </div>
                                    </div>



                                    <div class="col-12" id="editSelectContainer">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th class="my-th-width-sm">票券編號</th>
                                                        <th class="my-th-width">票券名稱</th>
                                                        <th class="my-th-width-sm">原價</th>
                                                        <th class="my-th-width-sm">促銷價</th>
                                                        <th class="my-th-width-sm"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 內容給JS填 -->
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                                <div class="m-3 d-flex justify-content-end">
                                    <button class="btn btn-primary" id="editPromotionSubmit">確定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bootstrap 核心 JavaScript -->
                <script src="vendor/jquery/jquery.min.js"></script>
                <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

                <!-- 核心插件 JavaScript -->
                <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

                <!-- 自訂腳本，適用於所有頁面 -->
                <script src="js/TripLight-2.min.js"></script>

                <!-- 頁面級別的插件 -->
                <script src="vendor/chart.js/Chart.min.js"></script>

                <!-- 頁面級別的自訂腳本 -->
                <script src="js/demo/chart-area-demo.js"></script>
                <script src="js/demo/chart-pie-demo.js"></script>
                <!-- 使用BootStrap-->

                <script src="vendor/bootstrap/js/bootstrap.bundle-5.2.3.js"></script>
                <script src="vendor/sweetalert/sweetalert.js"></script>
                <script src="js/bootstrap-table.min.js"></script>
                <script src="js/ticket_login_check.js"></script>

                <!-- TODO: -->
                <script>





                    let resultData;


                    //下拉選單與列表 
                    let selecterData = [];//裡面放的是票券
                    let tableData = [];//裡面放的是票券

                    let editSelecterData = [];//裡面放的是票券
                    let editTableData = [];//裡面放的是明細

                    $(function () {

                        let websocket = null;
                        if ('WebSocket' in window) {
                            // websocket = new WebSocket(`ws://localhost:8080/TicketDetail`);
                            websocket = new WebSocket(`wss://triplight.ddns.net/TicketDetail`);
                        }
                        websocket.onopen = () => {
                            // alert('open');
                        }
                        //當ws發生錯誤
                        websocket.onerror = function () {
                            //alert("連線錯誤,請稍後再次嘗試！");
                        };

                        //接收訊息
                        websocket.onmessage = function (event) {
                            // var result = event.data 
                        }
                        //離開網頁時關閉ws
                        window.onbeforeunload = function () {
                            websocket.close();
                            // console.log('close');
                        }
                        function send(post) {
                            if (websocket) {
                                websocket.send('[bk]:' + JSON.stringify(post));
                            }
                        }


                        fetch_data();



                        $('#testBtn').on('click', function () {

                            $('#addPromotionName').val('測試促銷');
                            $('#addPromotionStartDate').val('2023-03-26');
                            $('#addPromotionExpiryDate').val('2024-12-31');

                            //判斷上色
                            $('.form-floating .form-control').each((i, v) => renderTextColor(v));
                            $('.form-floating .form-select').each((i, v) => renderTextColor(v));
                        });

                        // 浮動標籤的變色
                        $('.form-floating .form-control').on('input', function () {
                            renderTextColor(this);
                        });
                        $('.form-floating .form-select').on('change', function () {
                            renderTextColor(this);
                        });

                        //確認編輯的按鈕
                        $('#editPromotionSubmit').on('click', function () {
                            const promotionId = $('#editPromotionId').text();
                            const post = {
                                promotionId: promotionId,
                                promotionTitle: $('#editPromotionName').val(),
                                startDate: $('#editPromotionStartDate').val(),
                                endDate: $('#editPromotionExpiryDate').val(),
                                promotionDetails: [
                                    {
                                        key: {
                                            promotionId: 0,
                                            ticketId: 1,
                                        },

                                        promotionPrice: 1,
                                    },
                                ]
                            }
                            post.promotionDetails = [];

                            for (let d of editTableData.sort((a, b) => a.ticket.ticketId - b.ticket.ticketId)) {


                                const promotionPrice = $(`#editPromotionPrice${d.ticket.ticketId}`).val();



                                if (!promotionPrice) {
                                    Swal.fire({ icon: 'error', title: '促銷價格未輸入' });
                                    return false;
                                }
                                if (promotionPrice <= 0) {
                                    Swal.fire({ icon: 'error', title: '促銷價格不可小於等於0' });
                                    return false;
                                }
                                if (promotionPrice >= d.ticket.price) {
                                    Swal.fire({ icon: 'error', title: '促銷價格高於原價...?' });
                                    return false;
                                }

                                post.promotionDetails.push(
                                    {
                                        key: {
                                            promotionId: promotionId,
                                            ticketId: d.ticket.ticketId,
                                        },

                                        promotionPrice: promotionPrice,
                                    }
                                );
                            }

                            if (!check(post)) {
                                return false;
                            }


                            fetch(`${getDomainName()}/bk/updatepromotion`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(post),
                            })
                                .then(response => response.json())
                                .then(data => Swal.fire({ icon: 'success', title: '編輯成功' }))
                                .catch(error => Swal.fire({ icon: 'error', title: '編輯失敗' }))
                                .finally(() => {
                                    fetch_data();
                                    $('#editPromotionModal').modal('hide');
                                    //通知客戶端變更了
                                    send(post);
                                });

                        });




                        //確認送出的按鈕
                        $('#addPromotionSubmit').on('click', function () {
                            const post = {
                                promotionId: null,
                                promotionTitle: $('#addPromotionName').val(),
                                startDate: $('#addPromotionStartDate').val(),
                                endDate: $('#addPromotionExpiryDate').val(),
                                promotionDetails: [
                                    {
                                        key: {
                                            promotionId: 0,
                                            ticketId: 1,
                                        },

                                        promotionPrice: 1,
                                    },
                                ]
                            }
                            post.promotionDetails = [];

                            for (let t of tableData.sort((a, b) => a.ticketId - b.ticketId)) {
                                const promotionPrice = $(`#promotionPrice${t.ticketId}`).val();
                                if (!promotionPrice) {
                                    Swal.fire({ icon: 'error', title: '促銷價格未輸入' });
                                    return false;
                                }
                                if (promotionPrice <= 0) {
                                    Swal.fire({ icon: 'error', title: '促銷價格不可小於等於0' });
                                    return false;
                                }
                                if (promotionPrice >= t.price) {
                                    Swal.fire({ icon: 'error', title: '促銷價格高於原價...?' });
                                    return false;
                                }

                                post.promotionDetails.push(
                                    {
                                        key: {
                                            promotionId: 0,
                                            ticketId: t.ticketId,
                                        },

                                        promotionPrice: promotionPrice,
                                    }
                                );
                            }

                            if (!check(post)) {
                                return false;
                            }


                            fetch(`${getDomainName()}/bk/addpromotion`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(post),
                            })
                                .then(response => response.json())
                                .then(data => Swal.fire({ icon: 'success', title: '新增成功' }))
                                .catch(error => Swal.fire({ icon: 'error', title: '新增失敗' }))
                                .finally(() => {
                                    fetch_data();
                                    $('#addPromotionModal').modal('hide');

                                    //通知客戶端變更了
                                    send(post);
                                });
                        });



                        function check(post) {
                            if (!post.promotionTitle) {
                                Swal.fire({ icon: 'error', title: '促銷名稱未輸入' });
                                return false;
                            }

                            if (!post.endDate) {
                                Swal.fire({ icon: 'error', title: '促銷到期日未輸入' });
                                return false;
                            }
                            if (!isDateAfterNow(post.endDate)) {
                                Swal.fire({ icon: 'error', title: '促銷到期日已經過期' });
                                return false;
                            }

                            if (!post.startDate) {
                                Swal.fire({ icon: 'error', title: '促銷開始日未輸入' });
                                return false;
                            }

                            if (isDateAfterTarget(post.startDate, post.endDate)) {
                                Swal.fire({ icon: 'error', title: '日期輸入錯誤' });
                                return false;
                            }

                            if (!post.promotionDetails || post.promotionDetails.length == 0) {
                                Swal.fire({ icon: 'error', title: '未選擇促銷商品' });
                                return false;
                            }
                            return true;
                        }

                        // 促銷列表物件的取消
                        $(document).on('click', '.my-btn-cancel', function () {
                            const ticketId = $(this).closest('tr').find('td').first().text();
                            const data = tableData.find(e => e.ticketId == ticketId);

                            if (!data) {
                                return;
                            }
                            //從table移除
                            tableData = tableData.filter(e => e.ticketId != ticketId);
                            render_table();

                            //放回select
                            selecterData.push(data);
                            render_select();
                        });

                        //下拉選單事件
                        $('#ticketSelect').on('change', function () {
                            const ticketId = $(this).val();
                            const data = selecterData.find(e => e.ticketId == ticketId);

                            if (!data) {
                                return;
                            }
                            //從select移除
                            selecterData = selecterData.filter(e => e.ticketId != ticketId);
                            render_select();

                            //放到table
                            tableData.push(data);
                            render_table();
                        });

                        // 新增促銷
                        $('#addPromotionBtn').on('click', function () {
                            fetch(`${getDomainName()}/bk/promotetickets`)
                                .then(response => response.json())
                                .then(data => {
                                    tableData = [];
                                    //未促銷的票券
                                    selecterData = data;
                                })
                                .catch(error => console.log(error))
                                .finally(() => {
                                    render_select();
                                    render_table();
                                    $('#addPromotionModal').modal('show');
                                });
                        });




                        // 點選列的事件
                        $(document).on('click', '#promotionContainer tbody tr', function () {
                            const promotionId = $(this).find('td').first().text();
                            $('#promotionId').text(promotionId);

                            fetch(`/bk/promotion/${promotionId}`)
                                .then(response => response.json())
                                .then(data => {
                                    $('#detailContainer').removeClass('d-none');
                                    $('#detailContainer table tbody').html('');

                                    const promotion = data;

                                    for (let detail of promotion.promotionDetails) {
                                        const ticket = detail.ticket;

                                        $('#detailContainer table tbody').append(`
                                            <tr>
                                                <td>${ticket.ticketId}</td>
                                                <td>${ticket.name}</td>
                                                <td>${ticket.price}</td>
                                                <td>${detail.promotionPrice}</td>
                                            </tr>
                                        `);
                                    }

                                })
                                .catch(error => console.log(error));
                        });
                    })


                    //編輯的按鈕
                    $(document).on('click', '.my-btn-edit', function () {
                        const promotionId = $(this).closest('tr').find('td').first().text();


                        //取得促銷本人
                        fetch(`/bk/promotion/${promotionId}`)
                            .then(response => response.json())
                            .then(data => {
                                const promotion = data;
                                $('#editPromotionId').text(promotion.promotionId);
                                $('#editPromotionName').val(promotion.promotionTitle);
                                $('#editPromotionStartDate').val(promotion.startDate);
                                $('#editPromotionExpiryDate').val(promotion.endDate);

                                //填入值
                                editTableData = [];
                                for (detail of promotion.promotionDetails) {
                                    editTableData.push(detail);
                                }
                                render_table_edit();

                                $('#editPromotionModal').modal('show');
                            })
                            .catch(error => console.log(error));

                        //取得未促銷的票券
                        fetch(`${getDomainName()}/bk/promotetickets`)
                            .then(response => response.json())
                            .then(data => {

                                //未促銷的票券
                                editSelecterData = data;
                            })
                            .catch(error => console.log(error))
                            .finally(() => {
                                render_select_edit();

                            });
                        return false;
                    });

                    //編輯下拉選單事件
                    $('#editTicketSelect').on('change', function () {
                        const ticketId = $(this).val();
                        const ticket = editSelecterData.find(e => e.ticketId == ticketId);

                        if (ticket) {
                            //從select移除
                            editSelecterData = editSelecterData.filter(e => e.ticketId != ticketId);
                            render_select_edit();

                            //放到table
                            editTableData.push({
                                promotionPrice: ticket.price,
                                ticket: ticket,
                            });
                            render_table_edit();
                        }

                    });

                    // 編輯促銷列表物件的取消
                    $(document).on('click', '.my-btn-cancel-edit', function () {
                        const ticketId = $(this).closest('tr').find('td').first().text();
                        const detail = editTableData.find(e => e.ticket.ticketId == ticketId);
                        if (detail) {
                            //從table移除
                            editTableData = editTableData.filter(e => e.ticket.ticketId != ticketId);
                            render_table_edit();

                            //放回select
                            editSelecterData.push(detail.ticket);
                            render_select_edit();
                        }
                    });



                    function render_select_edit() {
                        $('#editTicketSelect').html('<option value="0" disabled>未選擇</option>');
                        for (let t of editSelecterData.sort((a, b) => a.ticketId - b.ticketId)) {
                            $('#editTicketSelect').append(`
                               <option value="${t.ticketId}">${t.name}</option>
                            `);
                        }
                        $('#editTicketSelect').val(0);
                    }
                    function render_table_edit() {
                        $('#editSelectContainer table tbody').html('');
                        for (let d of editTableData.sort((a, b) => a.ticket.ticketId - b.ticket.ticketId)) {
                            $('#editSelectContainer table tbody').append(`
                                <tr>
                                    <td>${d.ticket.ticketId}</td>
                                    <td>${d.ticket.name}</td>
                                    <td>${d.ticket.price}</td>
                                    <td>
                                        <input class="form-control" type="number" min="1" value="${d.promotionPrice}" id="editPromotionPrice${d.ticket.ticketId}">
                                    </td>
                                    <td>                                        
                                        <button class="btn btn-danger my-btn-cancel-edit">取消</button>                                        
                                    </td>
                                 </tr>
                            `);
                        }
                    }
                    //----------------------------------fetch
                    function fetch_data() {


                        $('#promotionContainer table').bootstrapTable('destroy');

                        $('#promotionContainer table').bootstrapTable({
                            sortable: true,
                            sortClass: 'table-active',
                            search: true,
                            searchAlign: 'left',
                            url: '/bk/promotions',
                            columns: [
                                { field: 'promotionId', title: '促銷編號', "sortable": true },
                                { field: 'promotionTitle', title: '促銷名稱', "sortable": true },
                                { field: 'startDate', title: '開始日期', "sortable": true, formatter: formatPayDate },
                                { field: 'endDate', title: '結束日期', "sortable": true, formatter: formatPayDate },
                                { field: 'action', title: '操作', formatter: formatActions },
                            ]
                        });


                    }
                    function formatPayDate(value, row, index) {
                        return df(value);
                    }
                    function formatActions(value, row, index) {
                        return '<button class="btn btn-primary my-btn-edit">編輯</button> ';
                    }

                    //--------------------------------------render

                    /**
                     * 渲染下拉式選單
                    */
                    function render_select() {
                        $('#ticketSelect').html('<option value="0" disabled>未選擇</option>');
                        for (let t of selecterData.sort((a, b) => a.ticketId - b.ticketId)) {
                            $('#ticketSelect').append(`
                               <option value="${t.ticketId}">${t.name}</option>
                            `);
                        }
                        $('#ticketSelect').val(0);
                    }

                    /**
                     * 渲染表格
                    */
                    function render_table() {
                        $('#selectContainer table tbody').html('');
                        for (let t of tableData.sort((a, b) => a.ticketId - b.ticketId)) {
                            $('#selectContainer table tbody').append(`
                                <tr>
                                    <td>${t.ticketId}</td>
                                    <td>${t.name}</td>
                                    <td>${t.price}</td>
                                    <td>
                                        <input class="form-control" type="number" min="1" id="promotionPrice${t.ticketId}">
                                    </td>
                                    <td>                                        
                                        <button class="btn btn-danger my-btn-cancel">取消</button>                                        
                                    </td>
                                 </tr>
                            `);
                        }
                    }

                    // 標籤文字上色
                    function renderTextColor(elem) {
                        $(elem).siblings('label').removeClass('my-text-lightgray text-primary');
                        if ($(elem).val()) {
                            $(elem).siblings('label').addClass('text-primary');
                        } else {
                            $(elem).siblings('label').addClass('my-text-lightgray');
                        }
                    }

                    //TODO: ------------------------------------------//好用的函式

                    //輸入的日期字串(yyyy-mm-dd) 是否在目前日期以後
                    function isDateAfterNow(dateString) {
                        if (!dateString) {
                            return false;
                        }
                        const dateParts = dateString.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // 月份從0開始
                        const day = parseInt(dateParts[2]);
                        const inputDate = new Date(year, month, day);
                        return inputDate.getTime() > new Date().getTime();
                    }

                    function isDateAfterTarget(dateString, dateString2) {
                        if (!dateString || !dateString2) {
                            return false;
                        }

                        const dateParts = dateString.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // 月份從0開始
                        const day = parseInt(dateParts[2]);
                        const inputDate = new Date(year, month, day);
                        //---------
                        const dateParts2 = dateString2.split('-');
                        const year2 = parseInt(dateParts2[0]);
                        const month2 = parseInt(dateParts2[1]) - 1; // 月份從0開始
                        const day2 = parseInt(dateParts2[2]);
                        const inputDate2 = new Date(year2, month2, day2);

                        return inputDate.getTime() > inputDate2.getTime();
                    }

                    //日期格式
                    function df(dateStr) {
                        if (!dateStr) {
                            return '--';
                        }
                        const date = new Date(dateStr);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0'); // 使用 padStart 填充月份前面的零
                        const day = String(date.getDate()).padStart(2, '0'); // 使用 padStart 填充日期前面的零
                        return `${year}/${month}/${day}`;
                    }

                    var employeeAccess = sessionStorage.getItem("管理員");
                    var employeeaccess2 = JSON.parse(employeeAccess);

                    $("#employee-access")
                        .text("員工:" + employeeaccess2.employeeName + "\n"
                            + "權限:" + employeeaccess2.employeeAccess);

                    // 根據帳限顯示導覽
                    if (employeeaccess2.employeeAccess === "超級管理員") {

                    } else if (employeeaccess2.employeeAccess === "員工管理員") {
                        $("#member-management").hide();
                        $("#firm-management").hide();
                        $("#ticket-management").hide();
                        $("#web-management").hide();
                        $("#customer-service").hide();
                    } else if (employeeaccess2.employeeAccess === "會員管理員") {
                        $("#employee-management").hide();
                        $("#firm-management").hide();
                        $("#ticket-management").hide();
                        $("#web-management").hide();
                        $("#customer-service").hide();
                    } else if (employeeaccess2.employeeAccess === "廠商管理員") {
                        $("#employee-management").hide();
                        $("#member-management").hide();
                        $("#ticket-management").hide();
                        $("#web-management").hide();
                        $("#customer-service").hide();
                    } else if (employeeaccess2.employeeAccess === "票卷管理員") {
                        $("#employee-management").hide();
                        $("#member-management").hide();
                        $("#firm-management").hide();
                        $("#web-management").hide();
                        $("#customer-service").hide();
                    } else if (employeeaccess2.employeeAccess === "網頁管理員") {
                        $("#employee-management").hide();
                        $("#member-management").hide();
                        $("#firm-management").hide();
                        $("#ticket-management").hide();
                        $("#customer-service").hide();
                    } else if (employeeaccess2.employeeAccess === "客服管理員") {
                        $("#employee-management").hide();
                        $("#member-management").hide();
                        $("#firm-management").hide();
                        $("#ticket-management").hide();
                        $("#web-management").hide();
                    }


                    //登出用
                    $("#logoutLink").click(function () {
                        $.ajax({
                            type: "GET",
                            url: "/BKlogout",
                            success: function () {
                                window.location.href = "/back-end/login.html";
                            },
                            error: function () {
                            }
                        });
                    });
                </script>

</body>

</html>